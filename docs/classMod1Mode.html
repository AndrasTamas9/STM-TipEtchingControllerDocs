<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>STM Tip Etching Controller: Mod1Mode Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">STM Tip Etching Controller
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pri-types">Private Types</a> &#124;
<a href="#pri-attribs">Private Attributes</a> &#124;
<a href="classMod1Mode-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">Mod1Mode Class Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Mode for surface detection and etching using a 30 V supply (MOD1).  
 <a href="classMod1Mode.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="Modes_8h_source.html">Modes.h</a>&gt;</code></p>
<div class="dynheader">
Inheritance diagram for Mod1Mode:</div>
<div class="dyncontent">
<div class="center"><img src="classMod1Mode__inherit__graph.png" border="0" usemap="#aMod1Mode_inherit__map" alt="Inheritance graph"/></div>
<map name="aMod1Mode_inherit__map" id="aMod1Mode_inherit__map">
<area shape="rect" title="Mode for surface detection and etching using a 30 V supply (MOD1)." alt="" coords="5,79,100,104"/>
<area shape="rect" href="structIMode.html" title="Interface for non&#45;blocking machine modes." alt="" coords="21,5,84,31"/>
<area shape="poly" title=" " alt="" coords="55,44,55,79,50,79,50,44"/>
</map>
<center><span class="legend">[<a href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for Mod1Mode:</div>
<div class="dyncontent">
<div class="center"><img src="classMod1Mode__coll__graph.png" border="0" usemap="#aMod1Mode_coll__map" alt="Collaboration graph"/></div>
<map name="aMod1Mode_coll__map" id="aMod1Mode_coll__map">
<area shape="rect" title="Mode for surface detection and etching using a 30 V supply (MOD1)." alt="" coords="201,108,296,133"/>
<area shape="rect" href="structIMode.html" title="Interface for non&#45;blocking machine modes." alt="" coords="5,5,68,31"/>
<area shape="poly" title=" " alt="" coords="73,34,171,82,224,105,222,110,169,86,71,39"/>
<area shape="rect" href="classLcd1602.html" title="Wrapper class for a 16x2 HD44780&#45;compatible LCD with PWM backlight control." alt="" coords="92,5,168,31"/>
<area shape="poly" title=" " alt="" coords="156,37,237,106,233,110,152,41"/>
<area shape="rect" href="classStepperDriver.html" title="Non&#45;blocking stepper motor driver with position and velocity control." alt="" coords="193,5,305,31"/>
<area shape="poly" title=" " alt="" coords="251,45,251,108,246,108,246,45"/>
<area shape="rect" href="classCurrentSensor.html" title="Non&#45;blocking RMS current measurement helper class." alt="" coords="329,5,443,31"/>
<area shape="poly" title=" " alt="" coords="367,43,317,86,275,110,272,106,314,82,364,39"/>
<area shape="rect" href="classMovingAverage.html" title="Fixed&#45;point, static moving average filter." alt="" coords="468,5,680,31"/>
<area shape="poly" title=" " alt="" coords="538,39,479,63,412,87,297,114,296,109,411,81,477,58,536,34"/>
</map>
<center><span class="legend">[<a href="graph_legend.html">legend</a>]</span></center></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:ae61c181065b3b6f32a15c53b6eb7a890" id="r_ae61c181065b3b6f32a15c53b6eb7a890"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#ae61c181065b3b6f32a15c53b6eb7a890">Mod1Mode</a> (<a class="el" href="classLcd1602.html">Lcd1602</a> &amp;lcd, <a class="el" href="classStepperDriver.html">StepperDriver</a> &amp;stepper, uint8_t relayPin1, uint8_t relayPin2, <a class="el" href="classCurrentSensor.html">CurrentSensor</a> &amp;current, float currentThreshold, float etchingThreshold, <a class="el" href="Modes_8h.html#ab04955aa9a0cde03c3f19b89d606528b">IAvg_t</a> &amp;Iavg, <a class="el" href="Modes_8h.html#adf369259dddd95255442495a6f6fa96f">IAvg_s</a> &amp;IavgS)</td></tr>
<tr class="memdesc:ae61c181065b3b6f32a15c53b6eb7a890"><td class="mdescLeft">&#160;</td><td class="mdescRight">Construct a new <a class="el" href="classMod1Mode.html" title="Mode for surface detection and etching using a 30 V supply (MOD1).">Mod1Mode</a> instance.  <br /></td></tr>
<tr class="separator:ae61c181065b3b6f32a15c53b6eb7a890"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab6905c6a718c0e904fca48fb9bdeb9a9" id="r_ab6905c6a718c0e904fca48fb9bdeb9a9"><td class="memItemLeft" align="right" valign="top">const char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#ab6905c6a718c0e904fca48fb9bdeb9a9">name</a> () const override</td></tr>
<tr class="memdesc:ab6905c6a718c0e904fca48fb9bdeb9a9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get the name of this mode.  <br /></td></tr>
<tr class="separator:ab6905c6a718c0e904fca48fb9bdeb9a9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aca5d7fc6351f06fb181fa358024138a8" id="r_aca5d7fc6351f06fb181fa358024138a8"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#aca5d7fc6351f06fb181fa358024138a8">begin</a> () override</td></tr>
<tr class="memdesc:aca5d7fc6351f06fb181fa358024138a8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize MOD1 mode.  <br /></td></tr>
<tr class="separator:aca5d7fc6351f06fb181fa358024138a8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aff19c0fd5e81f9f9cbd25e4efea6b9a4" id="r_aff19c0fd5e81f9f9cbd25e4efea6b9a4"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#aff19c0fd5e81f9f9cbd25e4efea6b9a4">step</a> () override</td></tr>
<tr class="memdesc:aff19c0fd5e81f9f9cbd25e4efea6b9a4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Execute one step of the MOD1 state machine.  <br /></td></tr>
<tr class="separator:aff19c0fd5e81f9f9cbd25e4efea6b9a4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8afb69c5a4ddc402cc7b8c7b9337087b" id="r_a8afb69c5a4ddc402cc7b8c7b9337087b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#a8afb69c5a4ddc402cc7b8c7b9337087b">end</a> () override</td></tr>
<tr class="memdesc:a8afb69c5a4ddc402cc7b8c7b9337087b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Cleanup performed when leaving MOD1 mode.  <br /></td></tr>
<tr class="separator:a8afb69c5a4ddc402cc7b8c7b9337087b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="inherit_header pub_methods_structIMode"><td colspan="2" onclick="javascript:toggleInherit('pub_methods_structIMode')"><img src="closed.png" alt="-"/>&#160;Public Member Functions inherited from <a class="el" href="structIMode.html">IMode</a></td></tr>
<tr class="memitem:aa6d28f0a2c76d54fa7cc452b5efee520 inherit pub_methods_structIMode" id="r_aa6d28f0a2c76d54fa7cc452b5efee520"><td class="memItemLeft" align="right" valign="top">virtual&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structIMode.html#aa6d28f0a2c76d54fa7cc452b5efee520">~IMode</a> ()</td></tr>
<tr class="memdesc:aa6d28f0a2c76d54fa7cc452b5efee520 inherit pub_methods_structIMode"><td class="mdescLeft">&#160;</td><td class="mdescRight">Virtual destructor for proper cleanup via base pointers.  <br /></td></tr>
<tr class="separator:aa6d28f0a2c76d54fa7cc452b5efee520 inherit pub_methods_structIMode"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-types" name="pri-types"></a>
Private Types</h2></td></tr>
<tr class="memitem:afa92ba8d7ed8dbe6a7a734de853a8dbf" id="r_afa92ba8d7ed8dbe6a7a734de853a8dbf"><td class="memItemLeft" align="right" valign="top">enum class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbf">State</a> : uint8_t { <br />
&#160;&#160;<a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbfafa585d32a02170e5d4aada3bd490a1b3">MovingDownDetect</a>
, <a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbfa0aea9cb3445215834a9c673e8a87afb0">Wait1</a>
, <a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbfae5d725300be2a3224f5ef30d542cc8a1">MoveDown1</a>
, <a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbfa0e8f4b6b678f165db16f833d2fa58224">Wait2</a>
, <br />
&#160;&#160;<a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbfa94d75119d47b1832d9f82c203d4ec3cc">Validate30V</a>
, <a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbfaee175b2d6ca4f79e6620824b6218a105">RelayHold</a>
, <a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbfa8aea1adee73ee3db9d7af9ac624bdeac">Etching</a>
, <a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbfadac93ad190ed07fce4282d1ca15e7107">MoveUpBump</a>
, <br />
&#160;&#160;<a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbfa4f43702c684b13d2eb3c97f642cb4c62">FinalLift</a>
, <a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbfaf92965e2c8a7afb3c1b9a5c09a263636">Done</a>
<br />
 }</td></tr>
<tr class="memdesc:afa92ba8d7ed8dbe6a7a734de853a8dbf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Internal state machine for MOD1 mode.  <a href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbf">More...</a><br /></td></tr>
<tr class="separator:afa92ba8d7ed8dbe6a7a734de853a8dbf"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-attribs" name="pri-attribs"></a>
Private Attributes</h2></td></tr>
<tr class="memitem:a1a1e430f8f6a32af3671a18af213ccf2" id="r_a1a1e430f8f6a32af3671a18af213ccf2"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classLcd1602.html">Lcd1602</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#a1a1e430f8f6a32af3671a18af213ccf2">lcd_</a></td></tr>
<tr class="memdesc:a1a1e430f8f6a32af3671a18af213ccf2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reference to LCD for on-screen messages and prompts.  <br /></td></tr>
<tr class="separator:a1a1e430f8f6a32af3671a18af213ccf2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa884f035b65ce51ffabaae4272c821ad" id="r_aa884f035b65ce51ffabaae4272c821ad"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classStepperDriver.html">StepperDriver</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#aa884f035b65ce51ffabaae4272c821ad">stepper_</a></td></tr>
<tr class="memdesc:aa884f035b65ce51ffabaae4272c821ad"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reference to the stepper driver controlling motion.  <br /></td></tr>
<tr class="separator:aa884f035b65ce51ffabaae4272c821ad"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8d665cf0bd3c0ec8b018eda0311891ab" id="r_a8d665cf0bd3c0ec8b018eda0311891ab"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#a8d665cf0bd3c0ec8b018eda0311891ab">relayPin1_</a></td></tr>
<tr class="memdesc:a8d665cf0bd3c0ec8b018eda0311891ab"><td class="mdescLeft">&#160;</td><td class="mdescRight">First relay control pin used for high-voltage switching.  <br /></td></tr>
<tr class="separator:a8d665cf0bd3c0ec8b018eda0311891ab"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1c9db06f96af3472ee0338a922bd02ee" id="r_a1c9db06f96af3472ee0338a922bd02ee"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#a1c9db06f96af3472ee0338a922bd02ee">relayPin2_</a></td></tr>
<tr class="memdesc:a1c9db06f96af3472ee0338a922bd02ee"><td class="mdescLeft">&#160;</td><td class="mdescRight">Second relay control pin used for high-voltage switching.  <br /></td></tr>
<tr class="separator:a1c9db06f96af3472ee0338a922bd02ee"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7b4f2b9ca4175c56ecfea947fe1c249a" id="r_a7b4f2b9ca4175c56ecfea947fe1c249a"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classCurrentSensor.html">CurrentSensor</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#a7b4f2b9ca4175c56ecfea947fe1c249a">current_</a></td></tr>
<tr class="memdesc:a7b4f2b9ca4175c56ecfea947fe1c249a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reference to the current sensor for threshold-based decisions.  <br /></td></tr>
<tr class="separator:a7b4f2b9ca4175c56ecfea947fe1c249a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a18e065e99d9d6ca66ac58dae44f10e69" id="r_a18e065e99d9d6ca66ac58dae44f10e69"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#a18e065e99d9d6ca66ac58dae44f10e69">threshold_</a></td></tr>
<tr class="memdesc:a18e065e99d9d6ca66ac58dae44f10e69"><td class="mdescLeft">&#160;</td><td class="mdescRight">Surface detection threshold based on corrected RMS current.  <br /></td></tr>
<tr class="separator:a18e065e99d9d6ca66ac58dae44f10e69"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a49d547c97ee1d6c8bfb21a695de56ac4" id="r_a49d547c97ee1d6c8bfb21a695de56ac4"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#a49d547c97ee1d6c8bfb21a695de56ac4">etchingThreshold_</a></td></tr>
<tr class="memdesc:a49d547c97ee1d6c8bfb21a695de56ac4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Threshold for terminating etching based on current drop.  <br /></td></tr>
<tr class="separator:a49d547c97ee1d6c8bfb21a695de56ac4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aadad9fda5d6a8d6cea341a1ee0fdb460" id="r_aadad9fda5d6a8d6cea341a1ee0fdb460"><td class="memItemLeft" align="right" valign="top">unsigned long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#aadad9fda5d6a8d6cea341a1ee0fdb460">etchStart_</a> = 0</td></tr>
<tr class="memdesc:aadad9fda5d6a8d6cea341a1ee0fdb460"><td class="mdescLeft">&#160;</td><td class="mdescRight">Timestamp (ms) when 30 V was turned on (start of etching/hold).  <br /></td></tr>
<tr class="separator:aadad9fda5d6a8d6cea341a1ee0fdb460"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3673a808117ccd9fbda4610bcea3db2c" id="r_a3673a808117ccd9fbda4610bcea3db2c"><td class="memItemLeft" align="right" valign="top"><a class="el" href="Modes_8h.html#ab04955aa9a0cde03c3f19b89d606528b">IAvg_t</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#a3673a808117ccd9fbda4610bcea3db2c">Iavg_</a></td></tr>
<tr class="memdesc:a3673a808117ccd9fbda4610bcea3db2c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Long-window moving average for current during etching/hold.  <br /></td></tr>
<tr class="separator:a3673a808117ccd9fbda4610bcea3db2c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8b6ee9353fc4804fa165924396446da3" id="r_a8b6ee9353fc4804fa165924396446da3"><td class="memItemLeft" align="right" valign="top"><a class="el" href="Modes_8h.html#adf369259dddd95255442495a6f6fa96f">IAvg_s</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#a8b6ee9353fc4804fa165924396446da3">IavgS_</a></td></tr>
<tr class="memdesc:a8b6ee9353fc4804fa165924396446da3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Short-window moving average for current during detection/validation.  <br /></td></tr>
<tr class="separator:a8b6ee9353fc4804fa165924396446da3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a230117739fe117efd3e5c41ec4594c67" id="r_a230117739fe117efd3e5c41ec4594c67"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbf">State</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#a230117739fe117efd3e5c41ec4594c67">st_</a> = <a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbfafa585d32a02170e5d4aada3bd490a1b3">State::MovingDownDetect</a></td></tr>
<tr class="memdesc:a230117739fe117efd3e5c41ec4594c67"><td class="mdescLeft">&#160;</td><td class="mdescRight">Current state in the MOD1 state machine.  <br /></td></tr>
<tr class="separator:a230117739fe117efd3e5c41ec4594c67"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a008ea5a4d081ba35eab5e05a17ce1f1b" id="r_a008ea5a4d081ba35eab5e05a17ce1f1b"><td class="memItemLeft" align="right" valign="top">unsigned long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#a008ea5a4d081ba35eab5e05a17ce1f1b">waitStart_</a> = 0</td></tr>
<tr class="memdesc:a008ea5a4d081ba35eab5e05a17ce1f1b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Generic wait-start timestamp used in various timed states.  <br /></td></tr>
<tr class="separator:a008ea5a4d081ba35eab5e05a17ce1f1b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aad1c94ccf5c22ed744983fff2414d944" id="r_aad1c94ccf5c22ed744983fff2414d944"><td class="memItemLeft" align="right" valign="top">unsigned long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#aad1c94ccf5c22ed744983fff2414d944">validateStart_</a> = 0</td></tr>
<tr class="memdesc:aad1c94ccf5c22ed744983fff2414d944"><td class="mdescLeft">&#160;</td><td class="mdescRight">Timestamp (ms) marking the beginning of the 30 V validation phase.  <br /></td></tr>
<tr class="separator:aad1c94ccf5c22ed744983fff2414d944"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afa25559d8259a3e4dfd9bf13a9cbc76e" id="r_afa25559d8259a3e4dfd9bf13a9cbc76e"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#afa25559d8259a3e4dfd9bf13a9cbc76e">pulseCount_</a> = 0</td></tr>
<tr class="memdesc:afa25559d8259a3e4dfd9bf13a9cbc76e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Count of relay pulse cycles executed (if pulses are used).  <br /></td></tr>
<tr class="separator:afa25559d8259a3e4dfd9bf13a9cbc76e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae95d497781fa1671867103238c908294" id="r_ae95d497781fa1671867103238c908294"><td class="memItemLeft" align="right" valign="top">unsigned long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#ae95d497781fa1671867103238c908294">pulseStart_</a> = 0</td></tr>
<tr class="memdesc:ae95d497781fa1671867103238c908294"><td class="mdescLeft">&#160;</td><td class="mdescRight">Timestamp (ms) of the start of the current pulse phase.  <br /></td></tr>
<tr class="separator:ae95d497781fa1671867103238c908294"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abec39d535bc6521f3f5d9726cf0ade0a" id="r_abec39d535bc6521f3f5d9726cf0ade0a"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#abec39d535bc6521f3f5d9726cf0ade0a">relayOn_</a> = false</td></tr>
<tr class="memdesc:abec39d535bc6521f3f5d9726cf0ade0a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Flag indicating whether the relay is currently ON (true) or OFF (false).  <br /></td></tr>
<tr class="separator:abec39d535bc6521f3f5d9726cf0ade0a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8c102d799b69344a8abcbd5741940b2b" id="r_a8c102d799b69344a8abcbd5741940b2b"><td class="memItemLeft" align="right" valign="top">unsigned long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#a8c102d799b69344a8abcbd5741940b2b">stopTime_</a> = 0</td></tr>
<tr class="memdesc:a8c102d799b69344a8abcbd5741940b2b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Timestamp (ms) when motion was stopped (useful for diagnostics).  <br /></td></tr>
<tr class="separator:a8c102d799b69344a8abcbd5741940b2b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5f4ac36be6423206177fa2c20fa48e74" id="r_a5f4ac36be6423206177fa2c20fa48e74"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMod1Mode.html#a5f4ac36be6423206177fa2c20fa48e74">bumpedUp1mm_</a> = false</td></tr>
<tr class="memdesc:a5f4ac36be6423206177fa2c20fa48e74"><td class="mdescLeft">&#160;</td><td class="mdescRight">Flag indicating whether a single upward bump has already been applied.  <br /></td></tr>
<tr class="separator:a5f4ac36be6423206177fa2c20fa48e74"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Mode for surface detection and etching using a 30 V supply (MOD1). </p>
<p>High-level behavior:</p><ul>
<li>Move downward while monitoring corrected RMS current until a threshold indicates surface contact.</li>
<li>Perform controlled plunges and 30 V validation pulses to confirm contact.</li>
<li>Enter an etching phase with 30 V on, moving slowly upward while observing the current.</li>
<li>Once the current falls below a configurable threshold, stop etching and lift the tool by a fixed distance.</li>
</ul>
<p>The mode uses a small state machine (State) to manage its internal phases. </p>
</div><h2 class="groupheader">Member Enumeration Documentation</h2>
<a id="afa92ba8d7ed8dbe6a7a734de853a8dbf" name="afa92ba8d7ed8dbe6a7a734de853a8dbf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afa92ba8d7ed8dbe6a7a734de853a8dbf">&#9670;&#160;</a></span>State</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">enum class <a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbf">Mod1Mode::State</a> : uint8_t</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">strong</span><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Internal state machine for MOD1 mode. </p>
<p>The sequence includes:</p><ul>
<li>MovingDownDetect : downward motion searching for surface via current.</li>
<li>Wait1 : pause after surface detection.</li>
<li>MoveDown1 : additional plunge after surface.</li>
<li>Wait2 : pause before validation.</li>
<li>Validate30V : 30 V validation period to confirm true contact.</li>
<li>RelayHold : 30 V ON pre-etch phase.</li>
<li>Etching : 30 V ON, slow upward etching with current monitoring.</li>
<li>MoveUpBump : optional upward bump behavior (if used).</li>
<li>FinalLift : final lift after etching is complete.</li>
<li>Done : terminal state indicating mode completion. </li>
</ul>
<table class="fieldtable">
<tr><th colspan="2">Enumerator</th></tr><tr><td class="fieldname"><a id="afa92ba8d7ed8dbe6a7a734de853a8dbfafa585d32a02170e5d4aada3bd490a1b3" name="afa92ba8d7ed8dbe6a7a734de853a8dbfafa585d32a02170e5d4aada3bd490a1b3"></a>MovingDownDetect&#160;</td><td class="fielddoc"></td></tr>
<tr><td class="fieldname"><a id="afa92ba8d7ed8dbe6a7a734de853a8dbfa0aea9cb3445215834a9c673e8a87afb0" name="afa92ba8d7ed8dbe6a7a734de853a8dbfa0aea9cb3445215834a9c673e8a87afb0"></a>Wait1&#160;</td><td class="fielddoc"></td></tr>
<tr><td class="fieldname"><a id="afa92ba8d7ed8dbe6a7a734de853a8dbfae5d725300be2a3224f5ef30d542cc8a1" name="afa92ba8d7ed8dbe6a7a734de853a8dbfae5d725300be2a3224f5ef30d542cc8a1"></a>MoveDown1&#160;</td><td class="fielddoc"></td></tr>
<tr><td class="fieldname"><a id="afa92ba8d7ed8dbe6a7a734de853a8dbfa0e8f4b6b678f165db16f833d2fa58224" name="afa92ba8d7ed8dbe6a7a734de853a8dbfa0e8f4b6b678f165db16f833d2fa58224"></a>Wait2&#160;</td><td class="fielddoc"></td></tr>
<tr><td class="fieldname"><a id="afa92ba8d7ed8dbe6a7a734de853a8dbfa94d75119d47b1832d9f82c203d4ec3cc" name="afa92ba8d7ed8dbe6a7a734de853a8dbfa94d75119d47b1832d9f82c203d4ec3cc"></a>Validate30V&#160;</td><td class="fielddoc"></td></tr>
<tr><td class="fieldname"><a id="afa92ba8d7ed8dbe6a7a734de853a8dbfaee175b2d6ca4f79e6620824b6218a105" name="afa92ba8d7ed8dbe6a7a734de853a8dbfaee175b2d6ca4f79e6620824b6218a105"></a>RelayHold&#160;</td><td class="fielddoc"></td></tr>
<tr><td class="fieldname"><a id="afa92ba8d7ed8dbe6a7a734de853a8dbfa8aea1adee73ee3db9d7af9ac624bdeac" name="afa92ba8d7ed8dbe6a7a734de853a8dbfa8aea1adee73ee3db9d7af9ac624bdeac"></a>Etching&#160;</td><td class="fielddoc"></td></tr>
<tr><td class="fieldname"><a id="afa92ba8d7ed8dbe6a7a734de853a8dbfadac93ad190ed07fce4282d1ca15e7107" name="afa92ba8d7ed8dbe6a7a734de853a8dbfadac93ad190ed07fce4282d1ca15e7107"></a>MoveUpBump&#160;</td><td class="fielddoc"></td></tr>
<tr><td class="fieldname"><a id="afa92ba8d7ed8dbe6a7a734de853a8dbfa4f43702c684b13d2eb3c97f642cb4c62" name="afa92ba8d7ed8dbe6a7a734de853a8dbfa4f43702c684b13d2eb3c97f642cb4c62"></a>FinalLift&#160;</td><td class="fielddoc"></td></tr>
<tr><td class="fieldname"><a id="afa92ba8d7ed8dbe6a7a734de853a8dbfaf92965e2c8a7afb3c1b9a5c09a263636" name="afa92ba8d7ed8dbe6a7a734de853a8dbfaf92965e2c8a7afb3c1b9a5c09a263636"></a>Done&#160;</td><td class="fielddoc"></td></tr>
</table>

</div>
</div>
<h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="ae61c181065b3b6f32a15c53b6eb7a890" name="ae61c181065b3b6f32a15c53b6eb7a890"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae61c181065b3b6f32a15c53b6eb7a890">&#9670;&#160;</a></span>Mod1Mode()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">Mod1Mode::Mod1Mode </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classLcd1602.html">Lcd1602</a> &amp;&#160;</td>
          <td class="paramname"><em>lcd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classStepperDriver.html">StepperDriver</a> &amp;&#160;</td>
          <td class="paramname"><em>stepper</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>relayPin1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>relayPin2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classCurrentSensor.html">CurrentSensor</a> &amp;&#160;</td>
          <td class="paramname"><em>current</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>currentThreshold</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>etchingThreshold</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="Modes_8h.html#ab04955aa9a0cde03c3f19b89d606528b">IAvg_t</a> &amp;&#160;</td>
          <td class="paramname"><em>Iavg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="Modes_8h.html#adf369259dddd95255442495a6f6fa96f">IAvg_s</a> &amp;&#160;</td>
          <td class="paramname"><em>IavgS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Construct a new <a class="el" href="classMod1Mode.html" title="Mode for surface detection and etching using a 30 V supply (MOD1).">Mod1Mode</a> instance. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">lcd</td><td>Reference to the LCD helper for user feedback. </td></tr>
    <tr><td class="paramname">stepper</td><td>Reference to the stepper driver for Z motion. </td></tr>
    <tr><td class="paramname">relayPin1</td><td>First relay control pin (part of 30 V switching). </td></tr>
    <tr><td class="paramname">relayPin2</td><td>Second relay control pin (part of 30 V switching). </td></tr>
    <tr><td class="paramname">current</td><td>Reference to the current sensor used for detection. </td></tr>
    <tr><td class="paramname">currentThreshold</td><td>Threshold for surface detection based on current. </td></tr>
    <tr><td class="paramname">etchingThreshold</td><td>Threshold for terminating the etching phase. </td></tr>
    <tr><td class="paramname">Iavg</td><td>Long-window moving average for current monitoring. </td></tr>
    <tr><td class="paramname">IavgS</td><td>Short-window moving average for smoothing/detection. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="aca5d7fc6351f06fb181fa358024138a8" name="aca5d7fc6351f06fb181fa358024138a8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aca5d7fc6351f06fb181fa358024138a8">&#9670;&#160;</a></span>begin()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void Mod1Mode::begin </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">override</span><span class="mlabel">virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initialize MOD1 mode. </p>
<p>Initialize MOD1 mode (surface detection + etching with 30V).</p>
<p>Sets up output pins, internal state machine variables, current-averaging filters, and initial motion parameters for downward surface search.</p>
<p>Behavior:</p><ul>
<li>Displays mode title on the LCD.</li>
<li>Configures relay pins and sets them to the initial safe state.</li>
<li>Resets state machine variables and current averaging helpers.</li>
<li>Enables the stepper motor and starts moving downward to search for the surface.</li>
<li>Enables current measurement for threshold-based detection and control. </li>
</ul>

<p>Implements <a class="el" href="structIMode.html#abf4c7c5e1758fc13058dac1dd0675982">IMode</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classMod1Mode_aca5d7fc6351f06fb181fa358024138a8_cgraph.png" border="0" usemap="#aclassMod1Mode_aca5d7fc6351f06fb181fa358024138a8_cgraph" alt=""/></div>
<map name="aclassMod1Mode_aca5d7fc6351f06fb181fa358024138a8_cgraph" id="aclassMod1Mode_aca5d7fc6351f06fb181fa358024138a8_cgraph">
<area shape="rect" title="Initialize MOD1 mode." alt="" coords="5,104,144,129"/>
<area shape="rect" href="classStepperDriver.html#a08ddf3dd4e038a8818de8a7200ddb4ec" title="Enable or disable the stepper driver." alt="" coords="213,5,377,31"/>
<area shape="poly" title=" " alt="" coords="90,102,134,71,191,40,211,32,213,37,193,44,137,75,93,106"/>
<area shape="rect" href="classMovingAverage.html#a84bdaf0937897d8baacad7cd1a927eac" title="Reset the filter contents and accumulator." alt="" coords="213,55,377,80"/>
<area shape="poly" title=" " alt="" coords="131,101,223,80,224,86,133,107"/>
<area shape="rect" href="classCurrentSensor.html#a908e354d16c44c67d2be1b501e18bfc7" title="Enable or disable measurement updates." alt="" coords="197,104,392,129"/>
<area shape="poly" title=" " alt="" coords="144,114,184,114,184,119,144,119"/>
<area shape="rect" href="classStepperDriver.html#a8fa4f67459e8366e83a2827fc4e8cf3a" title="Set continuous motion speed in mm/s." alt="" coords="192,154,397,194"/>
<area shape="poly" title=" " alt="" coords="125,127,205,148,204,153,124,132"/>
<area shape="rect" href="classLcd1602.html#a7004efb68a9891924331923c69706d52" title="Display two lines of flash&#45;resident text as a title." alt="" coords="235,219,354,244"/>
<area shape="poly" title=" " alt="" coords="90,127,134,165,162,186,193,204,223,215,221,220,191,208,160,190,131,169,87,131"/>
</map>
</div>

</div>
</div>
<a id="a8afb69c5a4ddc402cc7b8c7b9337087b" name="a8afb69c5a4ddc402cc7b8c7b9337087b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8afb69c5a4ddc402cc7b8c7b9337087b">&#9670;&#160;</a></span>end()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void Mod1Mode::end </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">override</span><span class="mlabel">virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Cleanup performed when leaving MOD1 mode. </p>
<p>Cleanup for MOD1 mode.</p>
<p>Ensures that the stepper is stopped and enabled, current measurement is disabled, and relay outputs are placed in a safe (OFF) state.</p>
<p>Ensures:</p><ul>
<li>stepper speed is set to zero and driver is enabled,</li>
<li>current measurement is disabled,</li>
<li>all relays are turned off (safe state). </li>
</ul>

<p>Implements <a class="el" href="structIMode.html#acc782a6205322e642a56aa122c8e0512">IMode</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classMod1Mode_a8afb69c5a4ddc402cc7b8c7b9337087b_cgraph.png" border="0" usemap="#aclassMod1Mode_a8afb69c5a4ddc402cc7b8c7b9337087b_cgraph" alt=""/></div>
<map name="aclassMod1Mode_a8afb69c5a4ddc402cc7b8c7b9337087b_cgraph" id="aclassMod1Mode_a8afb69c5a4ddc402cc7b8c7b9337087b_cgraph">
<area shape="rect" title="Cleanup performed when leaving MOD1 mode." alt="" coords="5,55,132,80"/>
<area shape="rect" href="classStepperDriver.html#a08ddf3dd4e038a8818de8a7200ddb4ec" title="Enable or disable the stepper driver." alt="" coords="201,5,365,31"/>
<area shape="poly" title=" " alt="" coords="124,52,213,31,214,36,125,57"/>
<area shape="rect" href="classCurrentSensor.html#a908e354d16c44c67d2be1b501e18bfc7" title="Enable or disable measurement updates." alt="" coords="185,55,380,80"/>
<area shape="poly" title=" " alt="" coords="132,65,172,65,172,70,132,70"/>
<area shape="rect" href="classStepperDriver.html#a8fa4f67459e8366e83a2827fc4e8cf3a" title="Set continuous motion speed in mm/s." alt="" coords="180,105,385,145"/>
<area shape="poly" title=" " alt="" coords="118,77,195,99,194,104,116,83"/>
</map>
</div>

</div>
</div>
<a id="ab6905c6a718c0e904fca48fb9bdeb9a9" name="ab6905c6a718c0e904fca48fb9bdeb9a9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab6905c6a718c0e904fca48fb9bdeb9a9">&#9670;&#160;</a></span>name()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const char * Mod1Mode::name </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">override</span><span class="mlabel">virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Get the name of this mode. </p>
<dl class="section return"><dt>Returns</dt><dd>Constant C-string "MOD1". </dd></dl>

<p>Implements <a class="el" href="structIMode.html#a531317dbb9f073f46bd6b7330ffc58e7">IMode</a>.</p>

</div>
</div>
<a id="aff19c0fd5e81f9f9cbd25e4efea6b9a4" name="aff19c0fd5e81f9f9cbd25e4efea6b9a4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aff19c0fd5e81f9f9cbd25e4efea6b9a4">&#9670;&#160;</a></span>step()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool Mod1Mode::step </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">override</span><span class="mlabel">virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Execute one step of the MOD1 state machine. </p>
<p>Execute one step of the MOD1 mode state machine.</p>
<p>Performs non-blocking progression through the MOD1 phases: downward detection, validation, etching, and final lift. This should be called repeatedly until it returns true to signal mode completion.</p>
<dl class="section return"><dt>Returns</dt><dd>true when the mode has completed and control may return to the menu, </dd>
<dd>
false while the mode is still active.</dd></dl>
<p>High-level sequence:</p><ol type="1">
<li>Move downward until the corrected RMS current exceeds a surface threshold.</li>
<li>Stop at the detected surface, then:<ul>
<li>move a small distance further down (plunge) after a wait,</li>
<li>perform a short 30 V validation to confirm contact, re-entering search if contact is false.</li>
</ul>
</li>
<li>Once confirmed:<ul>
<li>keep 30 V on for a 2 s pre-etch period (RelayHold),</li>
<li>then move upward slowly (etching) while monitoring current.</li>
</ul>
</li>
<li>When current falls below an etching threshold:<ul>
<li>stop etching,</li>
<li>turn off 30 V,</li>
<li>move up by 30 mm.</li>
</ul>
</li>
<li>Wait for the final lift to complete, then signal the mode is done.</li>
</ol>
<p>Safety:</p><ul>
<li>A global soft Z limit aborts the mode if the position leaves [Z_MIN, Z_MAX].</li>
</ul>
<dl class="section return"><dt>Returns</dt><dd>true when the mode has completed and control should return to the menu, </dd>
<dd>
false while the mode is still running. </dd></dl>

<p>Implements <a class="el" href="structIMode.html#a9fc61504224e0961d659341cde1140da">IMode</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classMod1Mode_aff19c0fd5e81f9f9cbd25e4efea6b9a4_cgraph.png" border="0" usemap="#aclassMod1Mode_aff19c0fd5e81f9f9cbd25e4efea6b9a4_cgraph" alt=""/></div>
<map name="aclassMod1Mode_aff19c0fd5e81f9f9cbd25e4efea6b9a4_cgraph" id="aclassMod1Mode_aff19c0fd5e81f9f9cbd25e4efea6b9a4_cgraph">
<area shape="rect" title="Execute one step of the MOD1 state machine." alt="" coords="5,280,136,305"/>
<area shape="rect" href="classCurrentSensor.html#a45514ec38e38d1ae4194ee6e07c90917" title="Get the baseline&#45;corrected RMS current." alt="" coords="196,5,408,31"/>
<area shape="poly" title=" " alt="" coords="71,279,80,233,99,168,113,133,132,99,155,67,182,40,188,36,191,40,186,44,159,71,136,102,118,135,104,170,85,235,76,280"/>
<area shape="rect" href="classStepperDriver.html#a4a66821f431c4db6d4f030c6b7003bd8" title="Check whether the driver is busy with a position move." alt="" coords="221,55,383,80"/>
<area shape="poly" title=" " alt="" coords="73,279,84,241,105,189,138,135,158,110,182,89,206,76,208,81,186,94,162,114,142,138,110,192,89,243,78,281"/>
<area shape="rect" href="classStepperDriver.html#a388099ce07ad1e470799bab91943d2e0" title="Start a non&#45;blocking relative move (mm)." alt="" coords="184,104,420,129"/>
<area shape="poly" title=" " alt="" coords="76,278,115,215,146,178,183,146,212,131,214,136,185,151,149,182,119,218,81,281"/>
<area shape="rect" href="classStepperDriver.html#a4d1715971817716be1a64e8b5c6c2197" title="Get the current logical position in millimeters." alt="" coords="468,155,665,180"/>
<area shape="poly" title=" " alt="" coords="79,278,120,233,150,209,183,190,251,169,322,157,391,153,454,153,454,159,391,158,322,162,252,174,185,195,153,213,124,237,83,282"/>
<area shape="rect" href="classLcd1602.html#a2922193bbb32f7cad2c48c5ad0f21f0c" title="Print a RAM&#45;resident C&#45;string." alt="" coords="245,205,359,231"/>
<area shape="poly" title=" " alt="" coords="95,278,135,258,183,239,230,227,231,232,185,245,138,263,97,282"/>
<area shape="rect" href="classMovingAverage.html#a84bdaf0937897d8baacad7cd1a927eac" title="Reset the filter contents and accumulator." alt="" coords="220,255,384,280"/>
<area shape="poly" title=" " alt="" coords="136,283,206,275,206,280,137,288"/>
<area shape="rect" href="classLcd1602.html#a0516b78aa7f4531924a132d2b256f534" title="Position the cursor." alt="" coords="229,304,375,329"/>
<area shape="poly" title=" " alt="" coords="137,297,215,305,215,310,136,302"/>
<area shape="rect" href="classCurrentSensor.html#a908e354d16c44c67d2be1b501e18bfc7" title="Enable or disable measurement updates." alt="" coords="205,353,399,379"/>
<area shape="poly" title=" " alt="" coords="99,303,185,338,219,348,218,353,183,343,97,308"/>
<area shape="rect" href="classStepperDriver.html#a8fa4f67459e8366e83a2827fc4e8cf3a" title="Set continuous motion speed in mm/s." alt="" coords="199,403,405,443"/>
<area shape="poly" title=" " alt="" coords="85,304,127,345,155,368,185,388,203,396,200,401,183,392,152,372,123,349,81,307"/>
<area shape="rect" href="classLcd1602.html#a7004efb68a9891924331923c69706d52" title="Display two lines of flash&#45;resident text as a title." alt="" coords="243,468,361,493"/>
<area shape="poly" title=" " alt="" coords="79,305,93,336,116,376,147,418,186,453,207,464,230,471,228,476,205,469,182,458,143,422,111,379,89,338,75,307"/>
<area shape="rect" href="classStepperDriver.html#ac202361e6f613a083200d36f664d64e7" title="Non&#45;blocking step scheduling; call frequently from loop()." alt="" coords="219,517,385,543"/>
<area shape="poly" title=" " alt="" coords="77,305,88,345,109,399,141,456,161,482,186,504,207,516,205,521,182,508,158,486,136,459,104,401,83,346,72,306"/>
<area shape="rect" href="classMovingAverage.html#ab66a3b068e54504c4cd58da6378b29d4" title="Insert a new floating&#45;point sample and compute the updated average." alt="" coords="214,567,390,592"/>
<area shape="poly" title=" " alt="" coords="76,305,84,353,102,420,117,457,135,493,158,525,186,553,202,564,199,568,182,557,154,529,130,495,112,459,97,422,79,354,71,306"/>
<area shape="rect" href="classStepperDriver.html#a3a28a7c422746be35ae93f227169972b" title="Start a non&#45;blocking move to an absolute position (mm)." alt="" coords="469,104,665,129"/>
<area shape="poly" title=" " alt="" coords="420,114,455,114,455,119,420,119"/>
<area shape="poly" title=" " alt="" coords="370,127,487,149,486,155,369,132"/>
<area shape="rect" href="classStepperDriver.html#acb72803a8fdbf2bd2e645b36a3d0306c" title="Emit a single step pulse and update the internal position counter." alt="" coords="473,517,661,543"/>
<area shape="poly" title=" " alt="" coords="385,527,459,527,459,533,385,533"/>
</map>
</div>

</div>
</div>
<h2 class="groupheader">Member Data Documentation</h2>
<a id="a5f4ac36be6423206177fa2c20fa48e74" name="a5f4ac36be6423206177fa2c20fa48e74"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5f4ac36be6423206177fa2c20fa48e74">&#9670;&#160;</a></span>bumpedUp1mm_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool Mod1Mode::bumpedUp1mm_ = false</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Flag indicating whether a single upward bump has already been applied. </p>
<p>Used to ensure that any corrective +1 mm upward motion happens only once when current drops below a given threshold (if that behavior is enabled). </p>

</div>
</div>
<a id="a7b4f2b9ca4175c56ecfea947fe1c249a" name="a7b4f2b9ca4175c56ecfea947fe1c249a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7b4f2b9ca4175c56ecfea947fe1c249a">&#9670;&#160;</a></span>current_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classCurrentSensor.html">CurrentSensor</a>&amp; Mod1Mode::current_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Reference to the current sensor for threshold-based decisions. </p>

</div>
</div>
<a id="a49d547c97ee1d6c8bfb21a695de56ac4" name="a49d547c97ee1d6c8bfb21a695de56ac4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a49d547c97ee1d6c8bfb21a695de56ac4">&#9670;&#160;</a></span>etchingThreshold_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">float Mod1Mode::etchingThreshold_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Threshold for terminating etching based on current drop. </p>

</div>
</div>
<a id="aadad9fda5d6a8d6cea341a1ee0fdb460" name="aadad9fda5d6a8d6cea341a1ee0fdb460"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aadad9fda5d6a8d6cea341a1ee0fdb460">&#9670;&#160;</a></span>etchStart_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">unsigned long Mod1Mode::etchStart_ = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Timestamp (ms) when 30 V was turned on (start of etching/hold). </p>

</div>
</div>
<a id="a3673a808117ccd9fbda4610bcea3db2c" name="a3673a808117ccd9fbda4610bcea3db2c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3673a808117ccd9fbda4610bcea3db2c">&#9670;&#160;</a></span>Iavg_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="Modes_8h.html#ab04955aa9a0cde03c3f19b89d606528b">IAvg_t</a>&amp; Mod1Mode::Iavg_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Long-window moving average for current during etching/hold. </p>

</div>
</div>
<a id="a8b6ee9353fc4804fa165924396446da3" name="a8b6ee9353fc4804fa165924396446da3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8b6ee9353fc4804fa165924396446da3">&#9670;&#160;</a></span>IavgS_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="Modes_8h.html#adf369259dddd95255442495a6f6fa96f">IAvg_s</a>&amp; Mod1Mode::IavgS_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Short-window moving average for current during detection/validation. </p>

</div>
</div>
<a id="a1a1e430f8f6a32af3671a18af213ccf2" name="a1a1e430f8f6a32af3671a18af213ccf2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1a1e430f8f6a32af3671a18af213ccf2">&#9670;&#160;</a></span>lcd_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classLcd1602.html">Lcd1602</a>&amp; Mod1Mode::lcd_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Reference to LCD for on-screen messages and prompts. </p>

</div>
</div>
<a id="afa25559d8259a3e4dfd9bf13a9cbc76e" name="afa25559d8259a3e4dfd9bf13a9cbc76e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afa25559d8259a3e4dfd9bf13a9cbc76e">&#9670;&#160;</a></span>pulseCount_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t Mod1Mode::pulseCount_ = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Count of relay pulse cycles executed (if pulses are used). </p>

</div>
</div>
<a id="ae95d497781fa1671867103238c908294" name="ae95d497781fa1671867103238c908294"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae95d497781fa1671867103238c908294">&#9670;&#160;</a></span>pulseStart_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">unsigned long Mod1Mode::pulseStart_ = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Timestamp (ms) of the start of the current pulse phase. </p>

</div>
</div>
<a id="abec39d535bc6521f3f5d9726cf0ade0a" name="abec39d535bc6521f3f5d9726cf0ade0a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abec39d535bc6521f3f5d9726cf0ade0a">&#9670;&#160;</a></span>relayOn_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool Mod1Mode::relayOn_ = false</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Flag indicating whether the relay is currently ON (true) or OFF (false). </p>

</div>
</div>
<a id="a8d665cf0bd3c0ec8b018eda0311891ab" name="a8d665cf0bd3c0ec8b018eda0311891ab"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8d665cf0bd3c0ec8b018eda0311891ab">&#9670;&#160;</a></span>relayPin1_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t Mod1Mode::relayPin1_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>First relay control pin used for high-voltage switching. </p>

</div>
</div>
<a id="a1c9db06f96af3472ee0338a922bd02ee" name="a1c9db06f96af3472ee0338a922bd02ee"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1c9db06f96af3472ee0338a922bd02ee">&#9670;&#160;</a></span>relayPin2_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t Mod1Mode::relayPin2_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Second relay control pin used for high-voltage switching. </p>

</div>
</div>
<a id="a230117739fe117efd3e5c41ec4594c67" name="a230117739fe117efd3e5c41ec4594c67"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a230117739fe117efd3e5c41ec4594c67">&#9670;&#160;</a></span>st_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbf">State</a> Mod1Mode::st_ = <a class="el" href="classMod1Mode.html#afa92ba8d7ed8dbe6a7a734de853a8dbfafa585d32a02170e5d4aada3bd490a1b3">State::MovingDownDetect</a></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Current state in the MOD1 state machine. </p>

</div>
</div>
<a id="aa884f035b65ce51ffabaae4272c821ad" name="aa884f035b65ce51ffabaae4272c821ad"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa884f035b65ce51ffabaae4272c821ad">&#9670;&#160;</a></span>stepper_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classStepperDriver.html">StepperDriver</a>&amp; Mod1Mode::stepper_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Reference to the stepper driver controlling motion. </p>

</div>
</div>
<a id="a8c102d799b69344a8abcbd5741940b2b" name="a8c102d799b69344a8abcbd5741940b2b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8c102d799b69344a8abcbd5741940b2b">&#9670;&#160;</a></span>stopTime_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">unsigned long Mod1Mode::stopTime_ = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Timestamp (ms) when motion was stopped (useful for diagnostics). </p>

</div>
</div>
<a id="a18e065e99d9d6ca66ac58dae44f10e69" name="a18e065e99d9d6ca66ac58dae44f10e69"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a18e065e99d9d6ca66ac58dae44f10e69">&#9670;&#160;</a></span>threshold_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">float Mod1Mode::threshold_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Surface detection threshold based on corrected RMS current. </p>

</div>
</div>
<a id="aad1c94ccf5c22ed744983fff2414d944" name="aad1c94ccf5c22ed744983fff2414d944"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aad1c94ccf5c22ed744983fff2414d944">&#9670;&#160;</a></span>validateStart_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">unsigned long Mod1Mode::validateStart_ = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Timestamp (ms) marking the beginning of the 30 V validation phase. </p>

</div>
</div>
<a id="a008ea5a4d081ba35eab5e05a17ce1f1b" name="a008ea5a4d081ba35eab5e05a17ce1f1b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a008ea5a4d081ba35eab5e05a17ce1f1b">&#9670;&#160;</a></span>waitStart_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">unsigned long Mod1Mode::waitStart_ = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Generic wait-start timestamp used in various timed states. </p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="Modes_8h_source.html">Modes.h</a></li>
<li><a class="el" href="Modes_8cpp.html">Modes.cpp</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
